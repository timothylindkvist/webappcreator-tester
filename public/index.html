<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Real-Time Website Generator</title>
  <meta name="description" content="Stream a site blueprint from a brief and generate full pages in real time." />
  <style>
    :root {
      --bg: #f7f9fb;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #1d4ed8; /* Zillow-esque strong blue */
      --accent: #22c55e;
      --border: #e2e8f0;
      --shadow: 0 8px 30px rgba(2,6,23,0.06);
      --radius: 16px;
      --focus: 0 0 0 3px rgba(29,78,216,0.35);
      --maxw: 1400px;
    }

    /* System UI stack, no blocking font loads */
    html { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; background: var(--bg); color: var(--text); }

    /* Fluid type */
    h1 { font-size: clamp(1.5rem, 2vw + 1rem, 2.2rem); margin: 0; }
    h2 { font-size: clamp(1.1rem, 1.2vw + .9rem, 1.6rem); margin: 0 0 .5rem; }
    p, label, button, input, textarea { font-size: clamp(.95rem, .3vw + .9rem, 1.05rem); }

    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .btn {
      background: var(--primary); color: #fff; border: 0; border-radius: 12px;
      padding: .7rem 1rem; cursor: pointer; box-shadow: var(--shadow);
    }
    .btn.secondary { background: #0ea5e9; }
    .btn.ghost { background: #eef2ff; color: var(--primary); box-shadow: none; }
    .btn:focus-visible { outline: none; box-shadow: var(--focus); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }

    header {
      position: sticky; top: 0; z-index: 50;
      background: var(--panel); box-shadow: var(--shadow);
    }
    .header-inner {
      max-width: var(--maxw); margin: 0 auto; display: grid; grid-template-columns: 1fr auto;
      gap: 1rem; align-items: center; padding: .8rem 1rem;
    }
    .brand { display: flex; align-items: center; gap: .75rem; }
    .brand-badge {
      width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), #60a5fa);
      box-shadow: var(--shadow);
    }
    .brand h1 { letter-spacing: .2px; }
    .header-actions { display: flex; align-items: center; gap: .5rem; }

    main { max-width: var(--maxw); margin: 1rem auto; padding: 0 1rem 1.5rem; }
    .grid {
      display: grid; grid-template-columns: 360px 1fr; gap: 1rem;
    }
    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
    }
    .panel {
      background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
    }
    .panel .inner { padding: 1rem; }
    .muted { color: var(--muted); }

    .controls { display: grid; gap: .75rem; }
    .field { display: grid; gap: .35rem; }
    .field label { font-weight: 600; }
    .field textarea, .field input {
      width: 100%; border: 1px solid var(--border); border-radius: 12px; padding: .7rem .8rem; background: #fff;
    }
    .field textarea:focus-visible, .field input:focus-visible { outline: none; box-shadow: var(--focus); border-color: #93c5fd; }

    .actions { display: flex; gap: .5rem; flex-wrap: wrap; }

    .progress {
      height: 4px; background: #e5e7eb; border-radius: 999px; overflow: hidden;
    }
    .progress .bar {
      width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), #60a5fa);
      transition: width .2s linear;
    }

    .blueprint-log {
      height: 300px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border-radius: 12px; border: 1px solid var(--border); background: #0b1020; color: #e2e8f0; padding: .75rem; white-space: pre-wrap;
    }

    .preview {
      display: grid; grid-template-rows: auto 1fr; min-height: 70vh;
    }
    .preview-header {
      display: flex; align-items: center; gap: .5rem; justify-content: space-between; padding: .8rem 1rem; border-bottom: 1px solid var(--border);
    }
    .nav { display: flex; gap: .25rem; flex-wrap: wrap; }
    .nav button {
      background: #f1f5f9; border: 1px solid var(--border); border-radius: 999px; padding: .45rem .7rem; cursor: pointer;
    }
    .nav button[aria-current="page"] {
      background: var(--primary); color: #fff; border-color: var(--primary);
    }

    .preview-frame { border: 0; width: 100%; height: calc(100vh - 220px); background: #fff; }
    @media (max-width: 1100px) {
      .preview-frame { height: 65vh; }
    }

    .code-view {
      height: 200px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border-top: 1px solid var(--border); padding: .75rem; background: #0b1020; color: #e2e8f0; white-space: pre;
    }

    .footer {
      max-width: var(--maxw); margin: 1rem auto 2rem; padding: 0 1rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <a href="#main" class="sr-only">Skip to main content</a>
  <header>
    <div class="header-inner" role="navigation" aria-label="Primary">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true"></div>
        <h1>Real-Time Website Generator</h1>
      </div>
      <div class="header-actions">
        <button id="btn-fullscreen" class="btn ghost" title="Toggle full-screen preview">Full Screen</button>
        <a href="/api/health" class="btn ghost" target="_blank" rel="noopener">Health</a>
        <a href="https://www.zillow.com/" class="btn ghost" target="_blank" rel="noopener">Style Ref</a>
      </div>
    </div>
  </header>

  <main id="main" tabindex="-1">
    <div class="grid">
      <!-- Left: Controls & Blueprint Log -->
      <section class="panel">
        <div class="inner">
          <h2>Controls</h2>
          <p class="muted">Enter a short brief; the app streams a Zillow-inspired site blueprint JSON, then generates pages on demand.</p>
          <div class="controls" role="form" aria-label="Generator controls">
            <div class="field">
              <label for="brief">Client brief</label>
              <textarea id="brief" rows="5" placeholder="e.g., Simple SaaS. Pages: Home, Features, Pricing, Contact. Tone: friendly. Primary CTA: Start free trial."></textarea>
            </div>
            <div class="field">
              <label for="styleRef">Optional style reference (HTML, text, or notes)</label>
              <textarea id="styleRef" rows="3" placeholder="e.g., Zillow-like layout: spacious grid, clear cards, strong blue accents"></textarea>
            </div>
            <div class="field">
              <label for="instruction">Optional extra instruction to GPT-5</label>
              <input id="instruction" placeholder="e.g., Use a dark hero and light cards." />
            </div>

            <div class="actions">
              <button id="btn-generate" class="btn">Generate Blueprint</button>
              <button id="btn-cancel" class="btn secondary">Cancel</button>
            </div>

            <div class="progress" aria-hidden="true">
              <div id="progress" class="bar"></div>
            </div>

            <h2 style="margin-top:1rem;">Blueprint (streamed)</h2>
            <div id="blueprintLog" class="blueprint-log" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <!-- Right: Preview -->
      <section class="panel preview" aria-label="Preview">
        <div class="preview-header">
          <div class="nav" id="nav" role="navigation" aria-label="Generated site navigation"></div>
          <div style="display:flex; gap:.5rem;">
            <button id="btn-show-html" class="btn ghost" title="Show current HTML source">Show HTML</button>
            <button id="btn-clear-cache" class="btn ghost" title="Clear cached pages">Clear Cache</button>
          </div>
        </div>
        <iframe id="preview" class="preview-frame" title="Live preview"></iframe>
        <pre id="code" class="code-view" hidden></pre>
      </section>
    </div>
  </main>

  <div class="footer">
    <p>CSS budget â‰¤ ~12KB. System fonts only. Streaming via Chat Completions. Accessibility: headings, labeled controls, skip link, visible focus outlines, reduced motion respected.</p>
  </div>

  <script>
    // Accessibility: programmatic skip link target focus
    document.querySelector('a[href="#main"]').addEventListener('click', e => {
      const main = document.getElementById('main');
      main.setAttribute('tabindex', '-1');
      main.focus();
    });

    const elBrief = document.getElementById('brief');
    const elStyleRef = document.getElementById('styleRef');
    const elInstruction = document.getElementById('instruction');
    const btnGenerate = document.getElementById('btn-generate');
    const btnCancel = document.getElementById('btn-cancel');
    const btnFullscreen = document.getElementById('btn-fullscreen');
    const btnShowHtml = document.getElementById('btn-show-html');
    const btnClearCache = document.getElementById('btn-clear-cache');
    const blueprintLog = document.getElementById('blueprintLog');
    const navEl = document.getElementById('nav');
    const preview = document.getElementById('preview');
    const codeView = document.getElementById('code');
    const progressBar = document.getElementById('progress');

    let currentController = null;
    let blueprint = null;
    const pageCache = new Map();
    let currentPath = '/';

    function setProgress(p) {
      progressBar.style.width = Math.max(0, Math.min(100, p)) + '%';
    }

    function normalizeBlueprintText(t) {
      // Strip code fences or accidental labels
      return t.replace(/```[a-zA-Z]*\n?|```/g, '').replace(/^\s*FILE:[^\n]*\n/gm, '');
    }

    function normalizeHTML(t) {
      const stripped = t.replace(/```[a-zA-Z]*\n?|```/g, '').replace(/^\s*FILE:[^\n]*\n/gm, '');
      // Heuristic: ensure we have an <html> or <!doctype html>
      if (!/<!doctype html>|<html[\s>]/i.test(stripped)) {
        return '<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Raw Output</title><style>body{font-family:ui-monospace,monospace;padding:1rem;white-space:pre-wrap}</style></head><body><pre>' + 
               escapeHtml(stripped) + '</pre></body></html>';
      }
      return stripped;
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[c]);
    }

    async function streamPOST(url, body, onChunk) {
      if (currentController) currentController.abort();
      currentController = new AbortController();
      const signal = currentController.signal;
      setProgress(1);

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        signal
      });

      // Log server headers for diagnostics
      try {
        console.log('headers:', Object.fromEntries(res.headers));
      } catch {}

      if (!res.ok || !res.body) {
        const text = await res.text().catch(()=>'Failed to read body');
        throw new Error(text || ('HTTP ' + res.status));
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let total = 0;

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        total += value.byteLength;
        setProgress(Math.min(95, 10 + Math.log10(total + 10) * 25));
        const chunk = decoder.decode(value, { stream: true });
        onChunk(chunk);
      }

      setProgress(100);
      currentController = null;
    }

    function cancelCurrent() {
      if (currentController) {
        currentController.abort();
        currentController = null;
      }
      setProgress(0);
    }

    btnCancel.addEventListener('click', cancelCurrent);

    btnGenerate.addEventListener('click', async () => {
      cancelCurrent();
      blueprint = null;
      blueprintLog.textContent = '';
      navEl.innerHTML = '';
      pageCache.clear();
      codeView.hidden = true;

      const body = {
        brief: elBrief.value.trim(),
        styleReference: elStyleRef.value.trim(),
        instruction: elInstruction.value.trim()
      };

      try {
        await streamPOST('/api/blueprint', body, (txt) => {
          blueprintLog.textContent += txt;
        });
        const raw = normalizeBlueprintText(blueprintLog.textContent);
        blueprint = JSON.parse(raw);
        buildNav(blueprint?.site?.pages || []);
        // Auto-load home if present
        const home = (blueprint.site?.pages || []).find(p => p.path === '/') || (blueprint.site?.pages || [])[0];
        if (home) show(home.path);
      } catch (err) {
        blueprintLog.textContent += "\n\n[Error] " + (err?.message || err);
      } finally {
        setTimeout(()=>setProgress(0), 600);
      }
    });

    function buildNav(pages) {
      navEl.innerHTML = '';
      pages.forEach(p => {
        const btn = document.createElement('button');
        btn.textContent = p.path;
        btn.setAttribute('data-path', p.path);
        btn.addEventListener('click', () => show(p.path));
        btn.setAttribute('aria-label', 'Show page ' + p.path);
        navEl.appendChild(btn);
      });
      updateNavAria('/');
    }

    function updateNavAria(path) {
      Array.from(navEl.querySelectorAll('button')).forEach(b => {
        const isCurrent = b.getAttribute('data-path') === path;
        if (isCurrent) {
          b.setAttribute('aria-current', 'page');
        } else {
          b.removeAttribute('aria-current');
        }
      });
    }

    async function show(path) {
      currentPath = path;
      updateNavAria(path);
      codeView.hidden = true;

      if (pageCache.has(path)) {
        setPreview(pageCache.get(path));
        return;
      }

      try {
        let html = '';
        await streamPOST('/api/page', { blueprint, pagePath: path }, (txt) => {
          html += txt;
          // Progressive preview: update occasionally
          if (html.length % 2048 < 1024) {
            setPreview(html, true);
          }
        });
        html = normalizeHTML(html);
        pageCache.set(path, html);
        setPreview(html);
      } catch (err) {
        const errorHtml = normalizeHTML(String(err?.message || err));
        setPreview(errorHtml);
      } finally {
        setTimeout(()=>setProgress(0), 600);
      }
    }

    function setPreview(html, isPartial) {
      const doc = normalizeHTML(html);
      preview.srcdoc = doc;
      if (!isPartial) {
        codeView.textContent = doc;
      }
    }

    btnShowHtml.addEventListener('click', () => {
      codeView.hidden = !codeView.hidden;
    });

    btnClearCache.addEventListener('click', () => {
      pageCache.clear();
      alert('Page cache cleared.');
    });

    // Full-screen toggle for the preview section
    btnFullscreen.addEventListener('click', async () => {
      const panel = document.querySelector('.panel.preview');
      const isFs = document.fullscreenElement;
      try {
        if (!isFs) await panel.requestFullscreen();
        else await document.exitFullscreen();
      } catch {}
    });

    // Example prefill for quick testing
    elBrief.value = "Simple SaaS. Pages: Home, Features, Pricing, Contact. Tone: friendly. Primary CTA: Start free trial.";
    elStyleRef.value = "Zillow-like spacious grid, strong blue primary, rounded cards, subtle shadows.";

  </script>
</body>
</html>
