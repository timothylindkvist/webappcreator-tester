<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Real-Time Website Generator</title>
  <style>
    :root { --bg:#0b1b2b; --card:#0e2238; --muted:#0c1f33; --text:#e9eef5; --accent:#2fb3ff; --ring:#7cc6ff; --ok:#59d38f; --warn:#ffd169; }
    * { box-sizing: border-box; }
    body { margin:0; font: 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    header { position: sticky; top:0; z-index: 10; background: linear-gradient(180deg, rgba(12,31,51,.9), rgba(12,31,51,.4)); backdrop-filter: blur(6px); border-bottom: 1px solid #14314d; }
    main { display: grid; grid-template-columns: 360px 1fr; gap: 12px; padding: 12px; }
    .panel { background: var(--card); border:1px solid #173651; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    .controls { padding: 12px; display: grid; gap: 8px; }
    label { font-weight: 600; }
    input, textarea { width: 100%; background: #0a1a2a; border:1px solid #16324a; color: var(--text); border-radius: 10px; padding: 10px; }
    textarea { min-height: 100px; resize: vertical; }
    button { background: var(--accent); color: #042034; border: none; padding: 10px 12px; border-radius: 10px; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .actions { display: flex; gap: 8px; align-items: center; }
    .progress { height: 3px; background: #071425; border-radius: 999px; overflow: hidden; }
    .progress .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #7cc6ff); transition: width .2s; }
    .stack { display: grid; gap: 12px; padding: 12px; }
    pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background: #071525; border-top: 1px solid #132c44; padding: 10px; border-radius: 0 0 14px 14px; }
    nav.sitenav { display:flex; gap:6px; padding:10px; border-bottom:1px solid #173651; background:#0c1f33; border-radius: 14px 14px 0 0; }
    nav.sitenav a { padding:8px 10px; border-radius:8px; text-decoration:none; color: var(--text); border: 1px solid #183955; }
    nav.sitenav a.current { background: var(--accent); color:#042034; border-color: #2fb3ff; font-weight: 700; }
    iframe { width: 100%; height: calc(100vh - 180px); border: 0; background: #fff; border-radius: 0 0 14px 14px; }
    .status { font-size: 12px; opacity: .8; }
  </style>
</head>
<body>
  <header class="panel">
    <div class="controls">
      <div class="actions">
        <input id="brief" placeholder="Short brief e.g., 'Landing page for an influencer agent'"/>
        <input id="styleRef" placeholder="Optional style reference URL"/>
        <button id="generateBtn">Generate</button>
        <button class="cancel" id="cancelBtn" disabled>Cancel</button>
        <button id="exportNextBtn" title="Export a Next.js (App Router) project from the current blueprint">Export Next.js</button>
        <span class="status" id="status"></span>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="stack">
        <strong>Blueprint stream</strong>
        <pre id="bpLog"></pre>
      </div>
    </section>

    <section class="panel">
      <nav class="sitenav" id="nav"></nav>
      <iframe id="preview" title="Live Preview"></iframe>
    </section>
  </main>

<script>
let controller = null;
let currentBlueprint = null;
let pageCache = new Map();

function setStatus(msg){ document.getElementById('status').textContent = msg; }
function setProgress(n){ document.getElementById('bar').style.width = Math.max(0, Math.min(100, n)) + '%'; }

async function streamBlueprint() {
  const brief = document.getElementById('brief').value;
  const styleReference = document.getElementById('styleRef').value || undefined;

  controller = new AbortController();
  const res = await fetch('/api/blueprint', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ brief, styleReference }),
    signal: controller.signal
  });

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  const logEl = document.getElementById('bpLog');
  logEl.textContent = '';
  setProgress(1);
  let total = 0;
  while(true){
    const { done, value } = await reader.read();
    if(done) break;
    const chunk = decoder.decode(value, { stream:true });
    total += chunk.length;
    logEl.textContent += chunk;
    setProgress(Math.min(90, 10 + total / 50));
  }
  setProgress(95);
  // try parsing
  let txt = logEl.textContent.trim();
  // strip code fences if any
  txt = txt.replace(/^```(json)?/,'').replace(/```$/,'');
  try{
    currentBlueprint = JSON.parse(txt);
    setStatus('Blueprint ready');
    setProgress(100);
    buildNav();
  }catch(e){
    setStatus('Invalid blueprint JSON');
    console.error(e);
  }
}

function buildNav(){
  const nav = document.getElementById('nav');
  nav.innerHTML = '';
  const pages = (currentBlueprint?.site?.pages) || [];
  pages.forEach((p, idx) => {
    const a = document.createElement('a');
    const href = (p.path || '/');
    a.href = '#';
    a.textContent = href === '/' ? 'Home' : href.replace('/','');
    a.onclick = (ev)=>{ ev.preventDefault(); openPage(href); };
    a.id = 'nav_' + idx;
    nav.appendChild(a);
  });
  if (pages.length) openPage(pages[0].path || '/');
}

async function openPage(pagePath){
  const nav = document.getElementById('nav').children;
  for (const el of nav) el.classList.remove('current');
  const idx = Array.from(nav).findIndex(a => a.textContent.toLowerCase() === (pagePath === '/' ? 'home' : pagePath.replace('/','')));
  if (idx >= 0) nav[idx].classList.add('current');

  const iframe = document.getElementById('preview');
  if (pageCache.has(pagePath)) {
    iframe.srcdoc = pageCache.get(pagePath);
    return;
  }

  setStatus('Generating ' + pagePath);
  const res = await fetch('/api/page', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ blueprint: currentBlueprint, pagePath })
  });
  const html = await res.text();
  pageCache.set(pagePath, html);
  iframe.srcdoc = html;
  setStatus('Ready');
}

document.getElementById('generateBtn').addEventListener('click', async () => {
  setStatus('Streaming blueprint…'); setProgress(3);
  document.getElementById('bpLog').textContent='';
  pageCache.clear();
  try { await streamBlueprint(); } catch(e){ setStatus('Error: ' + e.message); }
});

document.getElementById('cancelBtn').addEventListener('click', () => {
  if (controller) controller.abort();
  setStatus('Cancelled');
});

// Export Next.js
const exportBtn = document.getElementById('exportNextBtn');
exportBtn.addEventListener('click', async () => {
  try{
    if(!currentBlueprint){ alert('Generate a blueprint first.'); return; }
    setStatus('Exporting Next.js…');
    const res = await fetch('/api/export-next', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ blueprint: currentBlueprint })
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || 'Export failed');
    }
    const blob = await res.blob();
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    const name = (currentBlueprint?.site?.title?.toLowerCase().replace(/[^a-z0-9\-]+/g,'-') || 'site') + '.zip';
    a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    setStatus('Export ready');
  }catch(e){
    setStatus('Export error');
    alert('Export error: ' + e.message);
  }
});
</script>
</body>
</html>
